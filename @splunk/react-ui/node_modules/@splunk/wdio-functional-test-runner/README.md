# WebdriverIO functional test runner

A WebdriverIO based test runner designed to offer a comfortable and scalable functional testing
experience out of the box.

## Getting started

1. Use Splunk's internal npm repository by creating a `.npmrc` file in the root of your package,
and adding a registry entry to it:
    ```
    registry=https://repo.splunk.com/artifactory/api/npm/npm
    ```

2. Add `@splunk/wdio-functional-test-runner` to your `package.json` `devDependencies`:
    ```
    npm install -D @splunk/wdio-functional-test-runner
    ```

3. Create a test runner settings file in the root of your project, name it `functional.settings.js`:
    ```js
    module.exports = {
        source: 'src',
        specExtension: '.functional.js',
    };
    ```
    See `Runner settings` below for details on how to customize these settings for your project.

4. Add at least one profile. Building blocks for local, cloud, CI and ORCA testing are included in the package. It's recommended
 to start with local browser testing. Add a new file (`functional.local.conf.js`) to the root of your project:
    ```js
    const base = require('@splunk/wdio-functional-test-runner/functional.base').default;
    const local = require('@splunk/wdio-functional-test-runner/functional.local').default;
    const settings = require('./functional.settings');

    const config = base(settings);
    local(config);
    config.capabilities = [{ browserName: 'chrome' }];

    module.exports.config = config;
    ```
    This sets up local browser testing for Google Chrome, which has to be available on your machine.

5. This package provides the `splunk-wdio-functional-test-runner` binary for use in your `package.json`.
For example, call it like this:
    ```
    splunk-wdio-functional-test-runner functional.local.conf.js
    ```

## Runner settings

The test runner needs to know where to find tests, how to compile them, and which mode (fixture /
remote) to use. The default is remote mode, see the next section for an explanation of fixture mode.

- `source` – Relative path to your project's source directory. Required.
- `specExtension` - Specifies the extension of your spec files, for example: `.functional.js`. Required.
- `specWebpackProfile` – The test runner loads, modifies and uses this profile to compile your test
 spec files. Example: `webpack.test.config.js`. If unset the default config from `@splunk/webpack-configs`
 is used.
- `fixtureMode` – Enables compilation of test fixtures. The default is `false`. Use in combination with
the `httpServer` or `s3` block (see below).
- `fixtureExtension` – Specifies the extension of your fixture files, for example: `.fixture.jsx`.
 Required if `fixtureMode` is `true`.
- `fixtureTemplate` – Optionally allows overriding the default fixture HTML template. Custom templates
must contain a `div` with id `test-container`.
- `fixtureWebpackProfile` – The test runner loads, modifies and uses this profile to compile your test
 fixture files. Example: `webpack.test.config.js`. If unset the default config from `@splunk/webpack-configs`
 is used.
- `temp` – Relative or absolute path to a temporary directory the runner should use. It will create or empty this
path on startup.

## Test specs and fixture mode
Tests always have a spec file. This file contains your test definitions, and uses Mocha's `describe`,
`it`, … . The `browser` global provided by `wdio` is available in your tests.

Any assertion library that throws is supported, but `chai` is recommended. Example spec file
(`Number.functional.js`):

```js
import { assert } from 'chai';

describe('My test', () => {
    it('Works as expected', () => {
        const $myInput = browser.$('#number input');
        $myInput.click();
        assert.equal($myInput.getValue(), '', 'input has initial empty value');
    }
}
```

The API documentation for `browser` can be found [here](http://webdriver.io/api.html).

Spec files are compiled with `target` set to `node` – if a webpack configuration file is specified
using `specWebpackProfile`, make sure to not use any incompatible settings or plugins. Instances of
the `CommonsChunkPlugin` are removed for spec file compilation.

In fixture mode, every spec is resolved to a matching fixture file. Multiple specs can use the same fixture. The
algorithm to resolve a spec file to a fixture file is:
1) Build combinations of the spec's filename, separated by the dot character and ordered by descending length. For example:
`a/b/Component.Date.Complex.functional.js -> [Component.Date.Complex, Component.Date, Component]`
1) For each combination, resolve upwards from the spec file's directory. The first path that exists is chosen as the fixture file.
Considering the above example, `a/Component.Date.Complex.fixture.jsx` would take precedence over `a/b/Component.fixture.jsx`.

Note that fixture resolving stops at the main directory (`source` setting). Fixture files outside it are ignored.

Spec and fixture file extensions are configurable (see `specExtension` and `fixtureExtension`).

The fixture file defines the layout of components under test. The default export
must be a React component (functional or class). An example matching the test above is
(`Number.fixture.jsx`):

```js
import React, { Component } from 'react';
import Number from '@splunk/react-ui/Number';

export default class NumberFixture extends Component {
    constructor(props, ...rest) {
        super(props, ...rest);

        this.state = {
            value: null, // default empty
        };
    }

    render() {
        return <Number id="number" value={this.state.value} inline />;
    }
}
```

Navigating to a specific location isn't required when using fixtures, the runner takes care of this step.

## Options
The `splunk-wdio-functional-test-runner` binary supports the following options:

- `--filter <filter>` – Optional (comma separated) filter strings to limit the set of active tests. Filter strings are glob
patterns applied to the source directory of your project. Alphanumeric filter strings are shortcuts for component folders.
For example, `--filter Number` is treated as `**/Number/**`. If no filter strings are given (the default), the following glob
pattern is used: `**/*{settings.specExtension}`.
- `--runnerVerbose` – Enables detailed Runner logging. This concerns steps such as webpack output
and fixture navigation. The setting operates independently of `wdio`'s `--logLevel` option, which
can be used to control the verbosity of the actual test execution. Note that `--logLevel` uses
nonstandard levels, for example `command`, `data` and `result`. Reporters are also unaffected
by this setting – choose the included `dot` reporter for minimal verbosity. The default reporter is `spec`.

The main (mandatory) argument when invoking `splunk-wdio-functional-test-runner` is a path to a profile.

All options and arguments are forwarded to the `wdio` binary. Certain `wdio` features and settings are incompatible with the test runner.


## Profiles
A profile defines how and where tests should be executed, and how to process test results. This
package provides a couple of building blocks that can be used to assemble your profiles. All blocks
(except the `base` block) export a function accepting and returning a configuration object. See
 `Getting started` above for an example.

### Base (functional.base)
This block accepts a runner settings object instead of a configuration. Calling it as the first step of profile building is always required.

### Local (functional.local)
Intended for local browser testing, usually on developer machines. Activates `selenium-standalone`, a package that sets up
a local Selenium instance and downloads browser drivers automatically. Supports Chrome, Firefox and PhantomJS, if they
are installed on the local machine. Browsers are defined after calling the `local` configuration function:

```js
local(config);
config.capabilities = [{ browserName: 'chrome' }];
```

### Cloud (functional.cloud)
Configures cloud-based browser testing, using Sauce Labs. An account there is required, the credentials are read from two
environment variables: `SAUCE_USERNAME` and `SAUCE_ACCESS_KEY`. Like the `local` setup the active browser set is defined like this:

```js
cloud(config);
config.capabilities = [
    { browserName: 'chrome', platform: 'Windows 10', version: '64.0' },
    { browserName: 'internet explorer', platform: 'Windows 8.1', version: '11.0' },
];
```

### CI (functional.ci)
Activates JUnit-style XML output. Files are written to the `test-reports` subdirectory.

The building block function accepts an optional settings object, passed as the second parameter. Available settings and their defaults are:

- `sauce` – If set to `true` (the default), SauceLabs-specific functionality is enabled.
- `failOnEmptySuite` – If set to `true` (the default is `false`), creation of failing entries for empty suites is enabled.

Both settings are passed to the `Custom JUnit reporter`. See below for details.

```js
ci(config);
```

### HTTP server for fixtures (functional.httpServer)
Manages a lean HTTP server used to serve compiled fixture files. Uses port `49221`. This block sets `baseUrl` to
the environment variable `DOCKER_TCP_BIND_49221`, if set. Otherwise it will use the first external IP address found,
or `127.0.0.1` if none can be determined.

### S3 Upload for fixtures (functional.s3)
This block uploads fixtures to a S3 bucket before test execution. It deletes uploaded files after the test run. Note the following:

- The offical AWS SDK is used, this means its credentials resolving process applies: configuration files, environment variables, …
- The S3 bucket used must exist and "Enable website hosting" must be enabled. It is recommended to enable auto expiration.
- Uploaded files are assigned the ACL `public-read`. Do not use this block if your testing setup contains sensitive/confidential data.
- Uploaded files receive a random prefix. The same bucket can be used for parallel test runs.

Available settings and their defaults are:

- `bucket` – Name of the S3 bucket to use. This setting is required.
- `region` – The AWS region to use. The default is `us-west-1`.
- `accessKeyId` and `secretAccessKey` – Set both values to override AWS credentials.

### Orca (functional.orca)
Enables the creation and teardown of fresh Splunk deployments during testing. This block
will package a Splunk application and deploy it as part of the ORCA invocation. The address
of that deployment is used automatically (via WebdriverIO's `baseUrl`).

This requires either a local Docker or a Python ORCA module installation. ORCA must be preconfigured.

The building block function requires a settings object, passed as the second parameter. Available settings
and their defaults are:

- `appPath` – Absolute path to the Splunk application under test. This setting or a custom ORCA scenario (`scenario`) is required.
- `use` – If set to `docker` (the default), Docker will be used to run ORCA. Otherwise the Python
module is used.
- `when` – If set to `session` (the default), a new deployment will be created for every test suite/browser
combination. If set to `global` only one deployment is created and all tests are run against it.    
- `version` – Specify the ORCA version to use, e.g. `0.7.5`. Falsy values are ignored. The default
is `null`. Ignored if `use` isn't `docker`.
- `local` – Set to `true` to enable ORCA's local mode (`--local`). The default is `false`.
- `scenario` – Specify the ORCA scenario to use (default is `standalone_generic`). Note that the runner
will retrieve (from ORCA's output) the address of the first container with role `standalone`. This setting or `appPath` is required.
- `exposeSplunkInfo` - If set to `true`, will add a custom command `browser.getSplunkInfo()` which returns an object containing information about the splunk deployment. Useful when tests want to make REST requests to splunkd. The default is `false`.

### Splunk login (functional.splunklogin)
This block adds two helpers to the `browser` object:
- `splunkLogin()` – If the current page is Splunk's login page, calling this helper will fill out and submit the login form.
- `splunkUrl(target)` – A shortcut for `browser.url(target)` followed by `splunkLogin()`.

The building block function supports a settings object, passed as the second parameter. Available settings
and their defaults are:

- `user` – The default is `admin`.
- `password` – The default is `Chang3d!` (ORCA's default).

## Helpers

### Custom JUnit reporter (reporter.junit)

Same as `wdio-junit-reporter` but adds the following features:
- Output for the SauceLabs Jenkins plugin (example: `SauceOnDemandSessionID=123456789 job-name=XZY`)
- Create failing test suite XML entries for suites that are empty during test result collection. This is an attempt to cover
certain cases where wdio plugins fail and/or something else goes wrong during test execution, causing empty test suites
to get written to XML.

The CI building block adds this reporter by default and forwards the `sauce` and `failOnEmptySuite` settings.

## References

- [WebdriverIO (wdio)](http://webdriver.io)
- [Selenium](http://www.seleniumhq.org)
- [selenium-standalone](https://github.com/vvo/selenium-standalone)
- [Sauce Labs](https://saucelabs.com)
- [ORCA](https://confluence.splunk.com/display/PROD/Getting+Started+with+Orca)
- [Webpack](https://webpack.github.io)
- [Babel](https://github.com/babel)
- [Chai](http://chaijs.com)
